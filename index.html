<html><head><title>Envelope Maker</title>
<script type="text/javascript" src="blob-stream.js"></script>
<script type="text/javascript" src="pdfkit.js"></script>
<script type="text/javascript" src="jquery-3.1.1.min.js"></script>
<script type="text/javascript">
var config = {};

function centsToDollars(cents) {
  var str = cents + "";
  if (str.length < 2)
    str = "0" + str;
  if (str.length < 3)
    str = "0" + str;
  var len = str.length;
  return str.substring(0, len - 2) + '.' + str.substring(len - 2);
}

function oneNumberToWord(num) {
  return ["zero", "one", "two", "three", "four", "five", "six", "seven",
	  "eight", "nine"][num];
}

function numberToWords(num) {
  if (num == 0)
    return "zero";

  var ret = [];
  if (num > 999) {
    return "NUM TOO HIGH!";
  }
  if (num > 99) {
    ret.push(oneNumberToWord(Math.floor(num / 100)));
    ret.push("hundred");
    num = num % 100;
  }
  var needHyphen = false;
  if (num >= 20) {
    ret.push(["unused", "unused", "twenty", "thirty", "fourty", "fifty",
	      "sixty", "seventy", "eighty", "ninety"][Math.floor(num / 10)]);
    num = num % 10;
    needHyphen = true;
  } else if (num >= 10) {
    ret.push(["ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
	      "sixteen", "seventeen", "eighteen", "nineteen"][num - 10]);
    return ret.join(" ");
  }
  if (num > 0) {
    var word = oneNumberToWord(num);
    if (needHyphen) {
      ret[ret.length-1] += "-" + word;
    } else {
      ret.push(word);
    }
  }
  return ret.join(" ");
}

function capsWords(str) {
  return str.replace(/\b\w/g,
		     function(letter) { return letter.toUpperCase(); });
}

function priceToWords(dollars, cents) {
  var lowerCase = numberToWords(dollars) +
    (dollars == 1 ? " dollar" : " dollars");
  var upperCase = capsWords(lowerCase);
  if (cents > 0) {
    var lowerCaseCents = numberToWords(cents) +
      (cents == 1 ? " cent" : " cents");
    var upperCaseCents = capsWords(lowerCaseCents);
    upperCase += " and " + upperCaseCents;
  }
  return upperCase;
}

function rateToPercent(rate) {
  return (rate * 100) + "%";
}

function go() {
  // in cents:
  var subtotal = Math.round(parseFloat(document.getElementById('subtotal').value) * 100);
  var tax = Math.ceil(config.taxrate * subtotal);
  var total = subtotal + tax;

  var doc = new PDFDocument({'margins': {'top': 18, 'bottom': 18, 'left': 18, 'right': 18}});
  //doc.addPage();
  doc.font('Helvetica').fontSize(11);

  var LINE_HEIGHT = 15;
  
  for (var i = 0; i < config.lines.length; i++) {
    var line = config.lines[i].replace(/SUBTOTAL/g, centsToDollars(subtotal)).
      replace(/TAXRATE/g, rateToPercent(config.taxrate)).
      replace(/TAX/g, centsToDollars(tax)).
      replace(/FINAL/g, centsToDollars(total));
    doc.text(line, 72, 72 + LINE_HEIGHT * i);
  }

  // check parts:
  console.log("Digi-Key");
  var totalWords = centsToDollars(total).split('.')[0] + " dollars and " +
    centsToDollars(total).split('.')[1] + " cents";
  var now = new Date();
  var date = (now.getMonth() + 1) + "/" + (now.getDate()) + "/" + now.getFullYear();
  var memo = document.getElementById('memo').value;
  console.log(date);
  console.log(totalWords);
  console.log(memo);
  
  doc.fontSize(10);
  doc.text(date, 72 * 3.5, 72 * 8.875 + 2);
  doc.text("Digi-Key",
	  72 * .75, 72 * 9.375 - 2);
  doc.text(centsToDollars(total), 72 * (4 + 7/8), 72 * 9.375 - 2);
  doc.text(priceToWords(parseInt(centsToDollars(total).split('.')[0]),
			parseInt(centsToDollars(total).split('.')[1])),
	   72 * 1.25, 72 * 9.5 + 8);
  doc.text(memo, .75 * 72, 10.37 * 72 + 2);

  stream = doc.pipe(blobStream());
  doc.end();
  stream.on('finish', function() {
    window.open(stream.toBlobURL('application/pdf'));
  });
}

function updateLocation() {
  var suffix =
    './#from=' + encodeURIComponent(document.getElementById('from').value) +
    '&to=' + encodeURIComponent(document.getElementById('to').value) +
    '&usps=' + (document.getElementById('usps').checked ? '1' : '0');
  document.getElementById('link').href = suffix;
}

function prefill() {
  $.getJSON("config.json", function(data) {
    config = data;
    document.getElementById('envelopeLink').href = config.envelopeLink;
    document.getElementById('submit').disabled = false;
  });

}

</script>


</head>
<body onload="javascript:prefill()">
Subtotal: $<input id="subtotal" type="text" name="subtotal" value=""><br/>
Memo: <input id="memo" type="text" name="memo" value=""><br/>
<button id="submit" onclick="go()" disabled="true">Submit</button><br/>
<a href="" id="envelopeLink">Envelope</a><br/>
<a href="https://github.com/adlr/envelope">Fork me on GitHub</a>
</body>
</html>
